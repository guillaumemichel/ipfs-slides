\documentclass{pl-slide}

\usepackage[british]{babel}
\usepackage[british]{datetime2}
\usepackage{ulem}

\usepackage{tikz,calc}
\usetikzlibrary{shapes, shapes, arrows, chains, fit, quotes}

\tikzstyle{trienode} = [draw=graylight, rounded corners]
\tikzstyle{bucket} = [draw=graylight, rectangle]

\definecolor{verystable}{HTML}{13f6e9}
\definecolor{stableenough}{HTML}{ccff00}
\definecolor{unstable}{HTML}{ffa500}

%Information to be included in the title page:
\title{DHT Routing Table Health}
\subtitle{Our DHT is in good shape!}
\author{Guillaume Michel}
\handle{@guissou}
\group{ProbeLab}
\institute{Protocol Labs}
\event{IPFS Ã¾ing}
\date{\DTMdate{2022-07-15}}

\begin{document}

\frame{\titlepage}

\begin{frame}
\frametitle{Kademlia DHT Routing Table}
\begin{itemize}
	\item A Distributed Hash Table (DHT) is a decentralized overlay network
	\item Each node has to know some other peers to be connected to the network, this set of peers is the node's Routing Table
	\item Kademlia keeps peers in \texttt{k-buckets} sorting the \texttt{peer\_id} by XOR distance (or Common Prefix Length). Each bucket is capped at 20 peers
\end{itemize}
\end{frame}

\iffalse
\begin{frame}
\frametitle{Example: Routing Table of peer \texttt{01101000}}
\begin{columns}[onlytextwidth,t]
\begin{column}{0.19\textwidth}
	\textbf{Bucket 0}
   	\begin{enumerate}
   		\item 11010111
   		\item 10001011
   		\item 10101110
   		\item 11110101
   		\item 10000010
   		\item 11010100
   		\item 11000100
   		\item ...
   	\end{enumerate}
\end{column}
\begin{column}{0.19\textwidth}
	\textbf{Bucket 1}
   \begin{enumerate}
   		\item \textbf{0}0110101
   		\item \textbf{0}0001000
   		\item \textbf{0}0111011
   		\item \textbf{0}0101101
   		\item \textbf{0}0110100
   \end{enumerate}
\end{column}
\begin{column}{0.19\textwidth}
	\textbf{Bucket 2}
   \begin{enumerate}
   		\item \textbf{01}011101
   		\item \textbf{01}001111
   		\item \textbf{01}010110
   \end{enumerate}
\end{column}
\begin{column}{0.19\textwidth}
	\textbf{Bucket 3}
   \begin{enumerate}
   		\item \textbf{011}11011
   		\item \textbf{011}10001
   \end{enumerate}
\end{column}
\begin{column}{0.19\textwidth}
	\textbf{Bucket 4}
   	\begin{enumerate}
   		\item \textbf{0110}0011
   \end{enumerate}
\end{column}
\end{columns}
\end{frame}
\fi

\begin{frame}
\frametitle{Kademlia keyspace}
\begin{tikzpicture}[
	thick,
	scale=0.8,
  	every node/.style={scale=0.8},
    level 1/.style = {sibling distance=8.8cm},
    level 2/.style = {sibling distance=4.4cm},
    level 3/.style = {sibling distance=2.2cm},
    level 4/.style = {sibling distance=1.1cm},
    level distance = 1.5cm
]
 	\node[trienode] {root}
	child {
		node[trienode] (n0) {0}
		child {
			node[trienode] {00}
			child {
				node[trienode] {000}
				child {
					node[trienode] {0000}
				}
				child {
					node[trienode] {0001}
				}
			}
			child {
				node[trienode] {001}
				child {
					node[trienode] {0010}
				}
				child {
					node[trienode] {0011}
				}
			}
		}
		child {
			node[trienode] {01}
			child {
				node[trienode] {010}
				child {
					node[trienode] {0100}
				}
				child {
					node[trienode] {0101}
				}
			}
			child {
				node[trienode] {011}
				child {
					node[trienode] {0110}
				}
				child {
					node[trienode] {0111}
				}
			}
		}
	}
	child {
		node[trienode] {1}
		child {
			node[trienode] {10}
			child {
				node[trienode] (n100) {100}
				child {
					node[trienode] {1000}
				}
				child {
					node[trienode] {1001}
				}
			}
			child {
				node[trienode] {101}
				child {
					node[trienode] (n1010) {1010}
				}
				child {
					node[trienode] (n1011) {1011}
				}
			}
		}
		child {
			node[trienode] (n11) {11}
			child {
				node[trienode] {110}
				child {
					node[trienode] {1100}
				}
				child {
					node[trienode] {1101}
				}
			}
			child {
				node[trienode] {111}
				child {
					node[trienode] {1110}
				}
				child {
					node[trienode] {1111}
				}
			}
		}
	};
\end{tikzpicture}
\end{frame}

\begin{frame}
\frametitle{Kademlia keyspace}
\begin{tikzpicture}[
	thick,
	scale=0.8,
  	every node/.style={scale=0.8},
    level 1/.style = {sibling distance=8.8cm},
    level 2/.style = {sibling distance=4.4cm},
    level 3/.style = {sibling distance=2.2cm},
    level 4/.style = {sibling distance=1.1cm},
    level distance = 1.5cm
]
 	\node[trienode] {root}
	child {
		node[trienode] (n0) {0}
		child {
			node[trienode] {00}
			child {
				node[trienode] {000}
				child {
					node[trienode] {0000}
				}
				child {
					node[trienode] {0001}
				}
			}
			child {
				node[trienode] {001}
				child {
					node[trienode] {0010}
				}
				child {
					node[trienode] {0011}
				}
			}
		}
		child {
			node[trienode] {01}
			child {
				node[trienode] {010}
				child {
					node[trienode] {0100}
				}
				child {
					node[trienode] {0101}
				}
			}
			child {
				node[trienode] {011}
				child {
					node[trienode] {0110}
				}
				child {
					node[trienode] {0111}
				}
			}
		}
	}
	child {
		node[trienode] {1}
		child {
			node[trienode] {10}
			child {
				node[trienode] (n100) {100}
				child {
					node[trienode] {1000}
				}
				child {
					node[trienode] {1001}
				}
			}
			child {
				node[trienode] {101}
				child {
					node[trienode] (n1010) {\textbf{1010}}
				}
				child {
					node[trienode] (n1011) {1011}
				}
			}
		}
		child {
			node[trienode] (n11) {11}
			child {
				node[trienode] {110}
				child {
					node[trienode] {1100}
				}
				child {
					node[trienode] {1101}
				}
			}
			child {
				node[trienode] {111}
				child {
					node[trienode] {1110}
				}
				child {
					node[trienode] {1111}
				}
			}
		}
	};
	\node[below=of n1010] (ref) {Reference node};
	\draw[->,thick] (ref) -- (n1010);
\end{tikzpicture}
\end{frame}

\begin{frame}
\frametitle{Kademlia keyspace}
\begin{tikzpicture}[
	thick,
	scale=0.8,
  	every node/.style={scale=0.8},
    level 1/.style = {sibling distance=8.8cm},
    level 2/.style = {sibling distance=4.4cm},
    level 3/.style = {sibling distance=2.2cm},
    level 4/.style = {sibling distance=1.1cm},
    level distance = 1.5cm
]
 	\node[trienode] {root}
	child {
		node[trienode] (n0) {0}
		child {
			node[trienode] {00}
			child {
				node[trienode] {000}
				child {
					node[trienode] {0000}
				}
				child {
					node[trienode] {0001}
				}
			}
			child {
				node[trienode] {001}
				child {
					node[trienode] {0010}
				}
				child {
					node[trienode] {0011}
				}
			}
		}
		child {
			node[trienode] {01}
			child {
				node[trienode] {010}
				child {
					node[trienode] {0100}
				}
				child {
					node[trienode] {0101}
				}
			}
			child {
				node[trienode] {011}
				child {
					node[trienode] {0110}
				}
				child {
					node[trienode] {0111}
				}
			}
		}
	}
	child {
		node[trienode] {1}
		child {
			node[trienode] {10}
			child {
				node[trienode] (n100) {100}
				child {
					node[trienode] {1000}
				}
				child {
					node[trienode] {1001}
				}
			}
			child {
				node[trienode] {\textbf{101}}
				child {
					node[trienode] (n1010) {\textbf{1010}}
				}
				child {
					node[trienode] (n1011) {\textbf{101}1}
				}
			}
		}
		child {
			node[trienode] (n11) {11}
			child {
				node[trienode] {110}
				child {
					node[trienode] {1100}
				}
				child {
					node[trienode] {1101}
				}
			}
			child {
				node[trienode] {111}
				child {
					node[trienode] {1110}
				}
				child {
					node[trienode] {1111}
				}
			}
		}
	};
	\node[bucket, above=of n1011, yshift=-2cm, minimum width=1.1cm, minimum height=1cm, label=below:bucket3] {};
	\node[below=of n1010] (ref) {Reference node};
	\draw[->,thick] (ref) -- (n1010);
\end{tikzpicture}
\end{frame}

\begin{frame}
\frametitle{Kademlia keyspace}
\begin{tikzpicture}[
	thick,
	scale=0.8,
  	every node/.style={scale=0.8},
    level 1/.style = {sibling distance=8.8cm},
    level 2/.style = {sibling distance=4.4cm},
    level 3/.style = {sibling distance=2.2cm},
    level 4/.style = {sibling distance=1.1cm},
    level distance = 1.5cm
]
 	\node[trienode] {root}
	child {
		node[trienode] (n0) {0}
		child {
			node[trienode] {00}
			child {
				node[trienode] {000}
				child {
					node[trienode] {0000}
				}
				child {
					node[trienode] {0001}
				}
			}
			child {
				node[trienode] {001}
				child {
					node[trienode] {0010}
				}
				child {
					node[trienode] {0011}
				}
			}
		}
		child {
			node[trienode] {01}
			child {
				node[trienode] {010}
				child {
					node[trienode] {0100}
				}
				child {
					node[trienode] {0101}
				}
			}
			child {
				node[trienode] {011}
				child {
					node[trienode] {0110}
				}
				child {
					node[trienode] {0111}
				}
			}
		}
	}
	child {
		node[trienode] {1}
		child {
			node[trienode] {\textbf{10}}
			child {
				node[trienode] (n100) {\textbf{10}0}
				child {
					node[trienode] {\textbf{10}00}
				}
				child {
					node[trienode] {\textbf{10}01}
				}
			}
			child {
				node[trienode] {\textbf{101}}
				child {
					node[trienode] (n1010) {\textbf{1010}}
				}
				child {
					node[trienode] (n1011) {\textbf{101}1}
				}
			}
		}
		child {
			node[trienode] (n11) {11}
			child {
				node[trienode] {110}
				child {
					node[trienode] {1100}
				}
				child {
					node[trienode] {1101}
				}
			}
			child {
				node[trienode] {111}
				child {
					node[trienode] {1110}
				}
				child {
					node[trienode] {1111}
				}
			}
		}
	};
	\node[bucket, above=of n100, yshift=-3.5cm, minimum width=2.2cm, minimum height=2.5cm, label=below:bucket2] {};
	\node[bucket, above=of n1011, yshift=-2cm, minimum width=1.1cm, minimum height=1cm, label=below:bucket3] {};
	\node[below=of n1010] (ref) {Reference node};
	\draw[->,thick] (ref) -- (n1010);
\end{tikzpicture}
\end{frame}

\begin{frame}
\frametitle{Kademlia keyspace}
\begin{tikzpicture}[
	thick,
	scale=0.8,
  	every node/.style={scale=0.8},
    level 1/.style = {sibling distance=8.8cm},
    level 2/.style = {sibling distance=4.4cm},
    level 3/.style = {sibling distance=2.2cm},
    level 4/.style = {sibling distance=1.1cm},
    level distance = 1.5cm
]
 	\node[trienode] {root}
	child {
		node[trienode] (n0) {0}
		child {
			node[trienode] {00}
			child {
				node[trienode] {000}
				child {
					node[trienode] {0000}
				}
				child {
					node[trienode] {0001}
				}
			}
			child {
				node[trienode] {001}
				child {
					node[trienode] {0010}
				}
				child {
					node[trienode] {0011}
				}
			}
		}
		child {
			node[trienode] {01}
			child {
				node[trienode] {010}
				child {
					node[trienode] {0100}
				}
				child {
					node[trienode] {0101}
				}
			}
			child {
				node[trienode] {011}
				child {
					node[trienode] {0110}
				}
				child {
					node[trienode] {0111}
				}
			}
		}
	}
	child {
		node[trienode] {\textbf{1}}
		child {
			node[trienode] {\textbf{10}}
			child {
				node[trienode] (n100) {\textbf{10}0}
				child {
					node[trienode] {\textbf{10}00}
				}
				child {
					node[trienode] {\textbf{10}01}
				}
			}
			child {
				node[trienode] {\textbf{101}}
				child {
					node[trienode] (n1010) {\textbf{1010}}
				}
				child {
					node[trienode] (n1011) {\textbf{101}1}
				}
			}
		}
		child {
			node[trienode] (n11) {\textbf{1}1}
			child {
				node[trienode] {\textbf{1}10}
				child {
					node[trienode] {\textbf{1}100}
				}
				child {
					node[trienode] {\textbf{1}101}
				}
			}
			child {
				node[trienode] {\textbf{1}11}
				child {
					node[trienode] {\textbf{1}110}
				}
				child {
					node[trienode] {\textbf{1}111}
				}
			}
		}
	};
	\node[bucket, above=of n11, yshift=-5cm, minimum width=4.4cm, minimum height=4cm, label=below:bucket1] {};
	\node[bucket, above=of n100, yshift=-3.5cm, minimum width=2.2cm, minimum height=2.5cm, label=below:bucket2] {};
	\node[bucket, above=of n1011, yshift=-2cm, minimum width=1.1cm, minimum height=1cm, label=below:bucket3] {};
	\node[below=of n1010] (ref) {Reference node};
	\draw[->,thick] (ref) -- (n1010);
\end{tikzpicture}
\end{frame}

\begin{frame}
\frametitle{Kademlia keyspace}
\begin{tikzpicture}[
	thick,
	scale=0.8,
  	every node/.style={scale=0.8},
    level 1/.style = {sibling distance=8.8cm},
    level 2/.style = {sibling distance=4.4cm},
    level 3/.style = {sibling distance=2.2cm},
    level 4/.style = {sibling distance=1.1cm},
    level distance = 1.5cm
]
 	\node[trienode] {root}
	child {
		node[trienode] (n0) {0}
		child {
			node[trienode] {00}
			child {
				node[trienode] {000}
				child {
					node[trienode] {0000}
				}
				child {
					node[trienode] {0001}
				}
			}
			child {
				node[trienode] {001}
				child {
					node[trienode] {0010}
				}
				child {
					node[trienode] {0011}
				}
			}
		}
		child {
			node[trienode] {01}
			child {
				node[trienode] {010}
				child {
					node[trienode] {0100}
				}
				child {
					node[trienode] {0101}
				}
			}
			child {
				node[trienode] {011}
				child {
					node[trienode] {0110}
				}
				child {
					node[trienode] {0111}
				}
			}
		}
	}
	child {
		node[trienode] {\textbf{1}}
		child {
			node[trienode] {\textbf{10}}
			child {
				node[trienode] (n100) {\textbf{10}0}
				child {
					node[trienode] {\textbf{10}00}
				}
				child {
					node[trienode] {\textbf{10}01}
				}
			}
			child {
				node[trienode] {\textbf{101}}
				child {
					node[trienode] (n1010) {\textbf{1010}}
				}
				child {
					node[trienode] (n1011) {\textbf{101}1}
				}
			}
		}
		child {
			node[trienode] (n11) {\textbf{1}1}
			child {
				node[trienode] {\textbf{1}10}
				child {
					node[trienode] {\textbf{1}100}
				}
				child {
					node[trienode] {\textbf{1}101}
				}
			}
			child {
				node[trienode] {\textbf{1}11}
				child {
					node[trienode] {\textbf{1}110}
				}
				child {
					node[trienode] {\textbf{1}111}
				}
			}
		}
	};
	\node[bucket, above=of n0, yshift=-6.5cm, minimum width=8.8cm, minimum height=5.4cm, label=below:bucket0] {};
	\node[bucket, above=of n11, yshift=-5cm, minimum width=4.4cm, minimum height=4cm, label=below:bucket1] {};
	\node[bucket, above=of n100, yshift=-3.5cm, minimum width=2.2cm, minimum height=2.5cm, label=below:bucket2] {};
	\node[bucket, above=of n1011, yshift=-2cm, minimum width=1.1cm, minimum height=1cm, label=below:bucket3] {};
	\node[below=of n1010] (ref) {Reference node};
	\draw[->,thick] (ref) -- (n1010);
\end{tikzpicture}
\end{frame}

\iffalse
\begin{frame}
\frametitle{Kademlia keyspace}
\begin{tikzpicture}[
	thick,
	scale=0.8,
  	every node/.style={scale=0.8},
    level 1/.style = {sibling distance=8.8cm},
    level 2/.style = {sibling distance=4.4cm},
    level 3/.style = {sibling distance=2.2cm},
    level 4/.style = {sibling distance=1.1cm},
    level distance = 1.5cm
]
 	\node[trienode] {root}
	child {
		node[trienode] (n0) {0}
		child {
			node[trienode] {00}
			child {
				node[trienode] {000}
				child {
					node[trienode] {0000}
				}
				child {
					node[trienode] {0001}
				}
			}
			child {
				node[trienode] {001}
				child {
					node[trienode] {0010}
				}
				child {
					node[trienode] {0011}
				}
			}
		}
		child {
			node[trienode] {01}
			child {
				node[trienode] {010}
				child {
					node[trienode] {0100}
				}
				child {
					node[trienode] {0101}
				}
			}
			child {
				node[trienode] {011}
				child {
					node[trienode] {0110}
				}
				child {
					node[trienode] {0111}
				}
			}
		}
	}
	child {
		node[trienode] {1}
		child {
			node[trienode] {10}
			child {
				node[trienode] (n100) {100}
				child {
					node[trienode] {1000}
				}
				child {
					node[trienode] {1001}
				}
			}
			child {
				node[trienode] {101}
				child {
					node[trienode] (n1010) {1010}
				}
				child {
					node[trienode] (n1011) {1011}
				}
			}
		}
		child {
			node[trienode] (n11) {11}
			child {
				node[trienode] {110}
				child {
					node[trienode] {1100}
				}
				child {
					node[trienode] {1101}
				}
			}
			child {
				node[trienode] {111}
				child {
					node[trienode] {1110}
				}
				child {
					node[trienode] {1111}
				}
			}
		}
	};
	\node[bucket, above=of n0, yshift=-6.5cm, minimum width=8.8cm, minimum height=5.4cm, label=below:bucket0] {};
	\node[bucket, above=of n11, yshift=-5cm, minimum width=4.4cm, minimum height=4cm, label=below:bucket1] {};
	\node[bucket, above=of n100, yshift=-3.5cm, minimum width=2.2cm, minimum height=2.5cm, label=below:bucket2] {};
	\node[bucket, above=of n1011, yshift=-2cm, minimum width=1.1cm, minimum height=1cm, label=below:bucket3] {};
	\node[below=of n1010] (ref) {Reference node};
	\draw[->,thick] (ref) -- (n1010);
\end{tikzpicture}
\end{frame}
\fi

\begin{frame}
\frametitle{Example: Routing Table of peer \texttt{01101000}}
\begin{columns}[onlytextwidth,t]
\begin{column}{0.19\textwidth}
	\textbf{Bucket 0}
   	\begin{enumerate}
   		\item 11010111
   		\item 10001011
   		\item 10101110
   		\item 11110101
   		\item 10000010
   		\item 11010100
   		\item 11000100
   		\item ...
   	\end{enumerate}
\end{column}
\begin{column}{0.19\textwidth}
	\textbf{Bucket 1}
   \begin{enumerate}
   		\item \textbf{0}0110101
   		\item \textbf{0}0001000
   		\item \textbf{0}0111011
   		\item \textbf{0}0101101
   		\item \textbf{0}0110100
   \end{enumerate}
\end{column}
\begin{column}{0.19\textwidth}
	\textbf{Bucket 2}
   \begin{enumerate}
   		\item \textbf{01}011101
   		\item \textbf{01}001111
   		\item \textbf{01}010110
   \end{enumerate}
\end{column}
\begin{column}{0.19\textwidth}
	\textbf{Bucket 3}
   \begin{enumerate}
   		\item \textbf{011}11011
   		\item \textbf{011}10001
   \end{enumerate}
\end{column}
\begin{column}{0.19\textwidth}
	\textbf{Bucket 4}
   	\begin{enumerate}
   		\item \textbf{0110}0011
   \end{enumerate}
\end{column}
\end{columns}
\end{frame}


\begin{frame}
\frametitle{\texttt{k-bucket} replacement policy}
\begin{itemize}
    \item \texttt{Kademlia}: only when a bucket is full and there is a new candidate, least-recently seen and unreachable node gets evicted, but live nodes are never evicted
	\bigskip    
    \item \texttt{kubo} implementation: periodically ping nodes that it didn't hear of recently, and evict them if they don't respond
\end{itemize}
\end{frame}

\begin{frame}
\frametitle{Measurements data}
\begin{itemize}
    \item The Nebula Crawler crawls the IPFS network and provides all peers in the network along with their routing table for a point in time
    \item Data taken from 28 crawls over 1 week (4 crawls per day) starting on \texttt{2022-04-19}
\end{itemize}
\end{frame}

\begin{frame}
\frametitle{Methodology}
\begin{itemize}
	\item The Nebula Crawler provides a global snapshot of the network
	\item We can reconstruct the \texttt{k-buckets} of all peers by computing the XOR distance between a \texttt{peer\_id} and the \texttt{peer\_id}s of all peers in its routing table
	\item From the global snapshot we can find the closest peers to every other peer and verify if any peer is missing from a \texttt{k-bucket}
    \item Caveat: XOR distance is non-linear! Computationnaly expensive to find the closest peers to a specific \texttt{peer\_id}. A python Binary Trie implementation was built for this purpose
\end{itemize}
\end{frame}


\begin{frame}
\frametitle{Unreachable peers in the Routing Table}

\begin{columns}[onlytextwidth]
\begin{column}{0.38\textwidth}
Unreachable peers may still be referenced in other peers routing tables (stale entries)
\bigskip
   \begin{itemize}
   		\item Average for buckets \texttt{0} to \texttt{8}: \texttt{3.8\%} $\sim$ \texttt{0.75} peers
   		\item Average for buckets \texttt{9} to \texttt{21}: \texttt{15\%}
   \end{itemize}
\end{column}
\begin{column}{0.58\textwidth}
    \begin{center}
		\includegraphics[width=\textwidth]{plots/unreachable-peers.png}
    \end{center}
\end{column}
\end{columns}
\end{frame}

\begin{frame}
\frametitle{Peers distribution in the k-buckets}

\begin{columns}[onlytextwidth]
\begin{column}{0.38\textwidth}
   	\begin{itemize}
   		\item Peers distribution in bucket follows an exponential growth, capped at 20
   		\item Buckets \texttt{0-8} are missing on average \texttt{0.12} peers per bucket
   		\item Buckets \texttt{9-14} are missing on average \texttt{0.53} peers per bucket
   	\end{itemize}
\end{column}
\begin{column}{0.58\textwidth}
    \begin{center}
		\includegraphics[width=\textwidth]{plots/peers-distribution-including-missing.png}
    \end{center}
\end{column}
\end{columns}
\end{frame}


\begin{frame}
\frametitle{20 closest peers awareness}

\begin{columns}[onlytextwidth]
\begin{column}{0.38\textwidth}
\begin{enumerate}
   	\item Probability Density Function (PDF)
   	\item Cumulative Distribution Function (CDF)
\end{enumerate}
\bigskip
\begin{itemize}
   	\item \texttt{61.1\%} of the peers know all their 20 closest peers
   	\item \texttt{95.2\%} of the peers know at least 18 of their 20 closest peers
\end{itemize}
\end{column}
\begin{column}{0.58\textwidth}
    \begin{center}
		\includegraphics[width=\textwidth]{plots/known-peers-among-20-closest.png}
    \end{center}
\end{column}
\end{columns}
\end{frame}

\begin{frame}
\frametitle{Diversity in the k-buckets}

\begin{itemize}
	\item Live peers never get replaced in the \texttt{k-buckets} by design
	\item Eventually, buckets with many candidates (e.g buckets \texttt{0-1}) will be filled almost exclusively with a small number of very stable peers
	\item Routing for content \textit{far away} (in XOR distance) may become centralized on a small set of peers
	\item Bad for decentralization :(
	\item Bad for load balancing :(
\end{itemize}
\end{frame}

\iffalse

\begin{frame}
\frametitle{ADD replacement gradual schema}

\begin{enumerate}
	\item Initial state
	\item nodes disconnect with churn
	\item very stable peers will be strongly connected in bucket 0-1
	\item eventually, only stable peers will be in these buckets
	\item bootstrap peers are supposed to be very stable
	\item new nodes joining the network (even for a short while) will populate their buckets 0-1 with very stable peers provided by the bootstrap peers
\end{enumerate}
\end{frame}
\fi

\begin{frame}
\frametitle{Replacement in action: views of \texttt{buckets 0}}
\textbf{{\color{verystable}Very stable nodes} - {\color{stableenough}Stable enough nodes} - {\color{unstable}Unstable nodes}}

\begin{tikzpicture}[
  thick,
  minimum size=5mm,
  node distance=0.7cm and 3cm,
  >=stealth,
  bend angle=45,
  scale=0.9,
  every node/.style={scale=0.9},
  auto
]

\node (node0)  [rounded corners, align=center, draw=graylight,
             label=above:{\color{verystable}\textbf{node0}}] {
             \begin{minipage}[t][2.2cm]{1.2cm}
             \textbf{{\color{stableenough}node1}\\
              	{\color{unstable}node2}\\
              	{\color{unstable}node3}\\
              	{\color{verystable}node4}\\
              	{\color{stableenough}node5}\\
             }
			\end{minipage}

             };
\node (node1)  [rounded corners, align=center, draw=graylight, below=of node0,
             label=above:{\color{stableenough}\textbf{node1}}] {
             \begin{minipage}[t][2.2cm]{1.2cm}
             \textbf{{\color{verystable}node0}\\
              	{\color{unstable}node2}\\
              	{\color{unstable}node6}\\
              	{\color{unstable}node7}\\
              	{\color{stableenough}node8}\\
             }
			\end{minipage}

             };
            
\node (node2)  [rounded corners, align=center, draw=graylight, right=of node0,
             label=above:{\color{unstable}\textbf{node2}}] {
             \begin{minipage}[t][2.2cm]{1.2cm}
             \textbf{{\color{stableenough}node1}\\
              	{\color{unstable}node3}\\
              	{\color{verystable}node4}\\
              	{\color{stableenough}node5}\\
              	{\color{unstable}node7}\\
             }
			\end{minipage}

             };

\node (node3)  [rounded corners, align=center, draw=graylight, right=of node1,
             label=above:{\color{unstable}\textbf{node3}}] {
             \begin{minipage}[t][2.2cm]{1.2cm}
             \textbf{{\color{verystable}node0}\\
				{\color{stableenough}node1}\\
              	{\color{unstable}node2}\\
              	{\color{verystable}node4}\\
              	{\color{stableenough}node8}\\
             }
			\end{minipage}

             };
\node (node4)  [rounded corners, align=center, draw=graylight, right=of node2,
             label=above:{\color{verystable}\textbf{node4}}] {
             \begin{minipage}[t][2.2cm]{1.2cm}
             \textbf{{\color{stableenough}node1}\\
                {\color{unstable}node3}\\
              	{\color{unstable}node7}\\
                {\color{stableenough}node8}\\
             	{\color{verystable}node10}\\
             }
			\end{minipage}

             };

\node (node5)  [rounded corners, align=center, draw=graylight, right=of node3,
             label=above:{\color{stableenough}\textbf{node5}}] {
             \begin{minipage}[t][2.2cm]{1.2cm}
             \textbf{{\color{stableenough}node1}\\
              	{\color{unstable}node2}\\
              	{\color{unstable}node3}\\
              	{\color{verystable}node4}\\
              	{\color{stableenough}node5}\\
             }
			\end{minipage}

             };

\end{tikzpicture}
\end{frame}

\begin{frame}
\frametitle{Replacement in action: views of \texttt{buckets 0}}
\textbf{{\color{verystable}Very stable nodes} - {\color{stableenough}Stable enough nodes} - {\color{unstable}Unstable nodes}}

\begin{tikzpicture}[
  thick,
  minimum size=5mm,
  node distance=0.7cm and 3cm,
  >=stealth,
  bend angle=45,
  scale=0.9,
  every node/.style={scale=0.9},
  auto
]

\node (node0)  [rounded corners, align=center, draw=graylight,
             label=above:{\color{verystable}\textbf{node0}}] {
             \begin{minipage}[t][2.2cm]{1.2cm}
             \textbf{{\color{stableenough}node1}\\
              	\sout{node2}\\
              	\sout{node3}\\
              	{\color{verystable}node4}\\
              	{\color{stableenough}node5}\\
             }
			\end{minipage}

             };
\node (node1)  [rounded corners, align=center, draw=graylight, below=of node0,
             label=above:{\color{stableenough}\textbf{node1}}] {
             \begin{minipage}[t][2.2cm]{1.2cm}
             \textbf{{\color{verystable}node0}\\
              	\sout{node2}\\
              	\sout{node6}\\
              	\sout{node7}\\
              	{\color{stableenough}node8}\\
             }
			\end{minipage}

             };
            
\node (node2)  [rounded corners, align=center, draw=graylight, right=of node0,
             label=above:\sout{node2}] {
             \begin{minipage}[t][2.2cm]{1.2cm}
             \sout{node1}\\
              	\sout{node3}\\
              	\sout{node4}\\
              	\sout{node5}\\
              	\sout{node7}\\
			\end{minipage}
             };
             
\node (node3)  [rounded corners, align=center, draw=graylight, right=of node1,
             label=above:\sout{node3}] {
             \begin{minipage}[t][2.2cm]{1.2cm}
             \sout{node0}\\
              	\sout{node1}\\
              	\sout{node2}\\
              	\sout{node4}\\
              	\sout{node8}\\
			\end{minipage}
             };

\node (node4)  [rounded corners, align=center, draw=graylight, right=of node2,
             label=above:{\color{verystable}\textbf{node4}}] {
             \begin{minipage}[t][2.2cm]{1.2cm}
             \textbf{{\color{stableenough}node1}\\
                \sout{node3}\\
              	\sout{node7}\\
                {\color{stableenough}node8}\\
             	{\color{verystable}node10}\\
             }
			\end{minipage}

             };

\node (node5)  [rounded corners, align=center, draw=graylight, right=of node3,
             label=above:{\color{stableenough}\textbf{node5}}] {
             \begin{minipage}[t][2.2cm]{1.2cm}
             \textbf{{\color{stableenough}node1}\\
              	\sout{node2}\\
              	\sout{node3}\\
              	{\color{verystable}node4}\\
              	{\color{stableenough}node5}\\
             }
			\end{minipage}

             };

\end{tikzpicture}
\end{frame}

\begin{frame}
\frametitle{Replacement in action: views of \texttt{buckets 0}}
\textbf{{\color{verystable}Very stable nodes} - {\color{stableenough}Stable enough nodes} - {\color{unstable}Unstable nodes}}
\begin{tikzpicture}[
  thick,
  minimum size=5mm,
  node distance=0.7cm and 3cm,
  >=stealth,
  bend angle=45,
  scale=0.9,
  every node/.style={scale=0.9},
  auto
]

\node (node0)  [rounded corners, align=center, draw=graylight,
             label=above:{\color{verystable}\textbf{node0}}] {
             \begin{minipage}[t][2.2cm]{1.2cm}
             \textbf{{\color{stableenough}node1}\\
              	{\color{unstable}node20}\\
              	{\color{verystable}node11}\\
              	{\color{verystable}node4}\\
              	{\color{stableenough}node5}\\
             }
			\end{minipage}

             };
\node (node1)  [rounded corners, align=center, draw=graylight, below=of node0,
             label=above:{\color{stableenough}\textbf{node1}}] {
             \begin{minipage}[t][2.2cm]{1.2cm}
             \textbf{{\color{verystable}node0}\\
              	{\color{verystable}node12}\\
              	{\color{unstable}node21}\\
              	{\color{stableenough}node13}\\
              	{\color{stableenough}node8}\\
             }
			\end{minipage}

             };
            
\node (node2)  [rounded corners, align=center, draw=graylight, right=of node0,
             label=above:{\color{unstable}\textbf{node20}}] {
             \begin{minipage}[t][2.2cm]{1.2cm}
             \textbf{{\color{verystable}node0}\\
				{\color{stableenough}node1}\\
              	{\color{verystable}node4}\\
              	{\color{stableenough}node5}\\
              	{\color{unstable}node21}\\
             }
			\end{minipage}

             };

\node (node3)  [rounded corners, align=center, draw=graylight, right=of node1,
             label=above:{\color{unstable}\textbf{node21}}] {
             \begin{minipage}[t][2.2cm]{1.2cm}
             \textbf{{\color{verystable}node0}\\
              	{\color{verystable}node4}\\
              	{\color{stableenough}node5}\\
              	{\color{stableenough}node8}\\
              	{\color{verystable}node12}\\
             }
			\end{minipage}

             };
\node (node4)  [rounded corners, align=center, draw=graylight, right=of node2,
             label=above:{\color{verystable}\textbf{node4}}] {
             \begin{minipage}[t][2.2cm]{1.2cm}
             \textbf{{\color{stableenough}node1}\\
                {\color{stableenough}node8}\\
             	{\color{verystable}node10}\\
              	{\color{verystable}node12}\\
              	{\color{stableenough}node15}\\
             }
			\end{minipage}

             };

\node (node5)  [rounded corners, align=center, draw=graylight, right=of node3,
             label=above:{\color{stableenough}\textbf{node5}}] {
             \begin{minipage}[t][2.2cm]{1.2cm}
             \textbf{{\color{stableenough}node1}\\
              	{\color{verystable}node4}\\
              	{\color{stableenough}node5}\\
              	{\color{stableenough}node8}\\
              	{\color{unstable}node21}\\
             }
			\end{minipage}

             };

\end{tikzpicture}
\end{frame}


\begin{frame}
\frametitle{Replacement in action: views of \texttt{buckets 0}}
\textbf{{\color{verystable}Very stable nodes} - {\color{stableenough}Stable enough nodes} - {\color{unstable}Unstable nodes}}
\begin{tikzpicture}[
  thick,
  minimum size=5mm,
  node distance=0.7cm and 3cm,
  >=stealth,
  bend angle=45,
  scale=0.9,
  every node/.style={scale=0.9},
  auto
]

\node (node0)  [rounded corners, align=center, draw=graylight,
             label=above:{\color{verystable}\textbf{node0}}] {
             \begin{minipage}[t][2.2cm]{1.2cm}
             \textbf{\sout{node1}\\
              	\sout{node20}\\
              	{\color{verystable}node11}\\
              	{\color{verystable}node4}\\
              	\sout{node5}\\
             }
			\end{minipage}

             };
\node (node1)  [rounded corners, align=center, draw=graylight, below=of node0,
             label=above:\sout{node1}] {
             \begin{minipage}[t][2.2cm]{1.2cm}
             \sout{node0}\\
              \sout{node12}\\
              \sout{node21}\\
              \sout{node13}\\
              \sout{node8}\\
          
			\end{minipage}

             };
            
\node (node2)  [rounded corners, align=center, draw=graylight, right=of node0,
             label=above:\sout{node20}] {
             \begin{minipage}[t][2.2cm]{1.2cm}
             \sout{node0}\\
			 \sout{node1}\\
             \sout{node4}\\
              \sout{node5}\\
              \sout{node21}\\
             
			\end{minipage}

             };

\node (node3)  [rounded corners, align=center, draw=graylight, right=of node1,
             label=above:\sout{node21}] {
             \begin{minipage}[t][2.2cm]{1.2cm}
             \sout{node0}\\
             \sout{node4}\\
             \sout{node5}\\
             \sout{node8}\\
             \sout{node12}\\
			\end{minipage}

             };
\node (node4)  [rounded corners, align=center, draw=graylight, right=of node2,
             label=above:{\color{verystable}\textbf{node4}}] {
             \begin{minipage}[t][2.2cm]{1.2cm}
             \textbf{\sout{node1}\\
                \sout{node8}\\
             	{\color{verystable}node10}\\
              	{\color{verystable}node12}\\
              	\sout{node15}\\
             }
			\end{minipage}

             };

\node (node5)  [rounded corners, align=center, draw=graylight, right=of node3,
             label=above:\sout{node5}] {
             \begin{minipage}[t][2.2cm]{1.2cm}
             \sout{node1}\\
             \sout{node4}\\
             \sout{node5}\\
             \sout{node8}\\
             \sout{node21}\\
			\end{minipage}

             };

\end{tikzpicture}
\end{frame}

\begin{frame}
\frametitle{Replacement in action: views of \texttt{buckets 0}}
\textbf{{\color{verystable}Very stable nodes} - {\color{stableenough}Stable enough nodes} - {\color{unstable}Unstable nodes}}
\begin{tikzpicture}[
  thick,
  minimum size=5mm,
  node distance=0.7cm and 3cm,
  >=stealth,
  bend angle=45,
  scale=0.9,
  every node/.style={scale=0.9},
  auto
]

\node (node0)  [rounded corners, align=center, draw=graylight,
             label=above:{\color{verystable}\textbf{node0}}] {
             \begin{minipage}[t][2.2cm]{1.2cm}
             \textbf{
              	{\color{verystable}node4}\\
              	{\color{verystable}node11}\\
              	{\color{verystable}node23}\\
              	{\color{verystable}node32}\\
              	{\color{verystable}node35}\\
             }
			\end{minipage}

             };
\node (node1)  [rounded corners, align=center, draw=graylight, below=of node0,
             label=above:\sout{node1}] {
             \begin{minipage}[t][2.2cm]{1.2cm}
             \sout{node0}\\
              \sout{node12}\\
              \sout{node21}\\
              \sout{node13}\\
              \sout{node8}\\
          
			\end{minipage}

             };
            
\node (node2)  [rounded corners, align=center, draw=graylight, right=of node0,
             label=above:\sout{node20}] {
             \begin{minipage}[t][2.2cm]{1.2cm}
             \sout{node0}\\
			 \sout{node1}\\
             \sout{node4}\\
              \sout{node5}\\
              \sout{node21}\\
             
			\end{minipage}

             };

\node (node3)  [rounded corners, align=center, draw=graylight, right=of node1,
             label=above:\sout{node21}] {
             \begin{minipage}[t][2.2cm]{1.2cm}
             \sout{node0}\\
             \sout{node4}\\
             \sout{node5}\\
             \sout{node8}\\
             \sout{node12}\\
			\end{minipage}

             };
\node (node4)  [rounded corners, align=center, draw=graylight, right=of node2,
             label=above:{\color{verystable}\textbf{node4}}] {
             \begin{minipage}[t][2.2cm]{1.2cm}
             \textbf{{\color{verystable}node0}\\
             	{\color{verystable}node10}\\
              	{\color{verystable}node12}\\
             	{\color{verystable}node23}\\
              	{\color{verystable}node32}\\
             }
			\end{minipage}

             };

\node (node5)  [rounded corners, align=center, draw=graylight, right=of node3,
             label=above:\sout{node5}] {
             \begin{minipage}[t][2.2cm]{1.2cm}
             \sout{node1}\\
             \sout{node4}\\
             \sout{node5}\\
             \sout{node8}\\
             \sout{node21}\\
			\end{minipage}

             };

\end{tikzpicture}
\end{frame}

\begin{frame}
\frametitle{Replacement in action: views of \texttt{buckets 0}}
\textbf{{\color{verystable}Very stable nodes} - {\color{stableenough}Stable enough nodes} - {\color{unstable}Unstable nodes}}
\begin{tikzpicture}[
  thick,
  minimum size=5mm,
  node distance=0.7cm and 3cm,
  >=stealth,
  bend angle=45,
  scale=0.9,
  every node/.style={scale=0.9},
  auto
]

\node (node0)  [rounded corners, align=center, draw=graylight,
             label=above:{\color{verystable}\textbf{node0}}] {
             \begin{minipage}[t][2.2cm]{1.2cm}
             \textbf{
              	{\color{verystable}node4}\\
              	{\color{verystable}node11}\\
              	{\color{verystable}node23}\\
              	{\color{verystable}node32}\\
              	{\color{verystable}node35}\\
             }
			\end{minipage}

             };
\node (node1)  [rounded corners, align=center, draw=graylight, below=of node0,
             label=above:{\color{stableenough}\textbf{node36}}] {
             \begin{minipage}[t][2.2cm]{1.2cm}
             \textbf{
              	{\color{verystable}node4}\\
              	{\color{verystable}node11}\\
              	{\color{verystable}node12}\\
             	{\color{verystable}node23}\\
              	{\color{unstable}node39}\\
             }
			\end{minipage}

             };
            
\node (node2)  [rounded corners, align=center, draw=graylight, right=of node0,
             label=above:{\color{unstable}\textbf{node37}}] {
             \begin{minipage}[t][2.2cm]{1.2cm}
             \textbf{{\color{verystable}node0}\\
              	{\color{verystable}node4}\\
              	{\color{verystable}node12}\\
             	{\color{verystable}node23}\\
              	{\color{verystable}node35}\\
             }
			\end{minipage}

             };

\node (node3)  [rounded corners, align=center, draw=graylight, right=of node1,
             label=above:{\color{unstable}\textbf{node39}}] {
             \begin{minipage}[t][2.2cm]{1.2cm}
             \textbf{{\color{verystable}node0}\\
             	{\color{verystable}node4}\\
              	{\color{verystable}node12}\\
              	{\color{verystable}node32}\\
              	{\color{stableenough}node41}\\
             }
			\end{minipage}

             };
\node (node4)  [rounded corners, align=center, draw=graylight, right=of node2,
             label=above:{\color{verystable}\textbf{node4}}] {
             \begin{minipage}[t][2.2cm]{1.2cm}
             \textbf{{\color{verystable}node0}\\
             	{\color{verystable}node10}\\
              	{\color{verystable}node12}\\
             	{\color{verystable}node23}\\
              	{\color{verystable}node32}\\
             }
			\end{minipage}

             };

\node (node5)  [rounded corners, align=center, draw=graylight, right=of node3,
             label=above:{\color{stableenough}\textbf{node41}}] {
             \begin{minipage}[t][2.2cm]{1.2cm}
             \textbf{{\color{verystable}node0}\\
             	{\color{verystable}node10}\\
              	{\color{verystable}node11}\\
             	{\color{verystable}node23}\\
              	{\color{verystable}node35}\\
             }
			\end{minipage}

             };

\draw[<-, thick] (node0.east) -- (node2.west);
\draw[<-, thick] (node0.east) -- (node3.west);
\draw[<-, thick] (node4.west) -- (node2.east);
\draw[<-, thick] (node4.west) -- (node3.east);

%\draw[->, thick] ([yshift=-0.3cm] peer0.west) -- node[midway, above]{\texttt{Peer1}} ([yshift=-0.3cm] client.east |-peer0.west);


\end{tikzpicture}
\end{frame}



\begin{frame}
\frametitle{New measurements}
\begin{columns}[onlytextwidth]
\begin{column}{0.38\textwidth}
   \begin{itemize}
   		\item Measurements for 10 consecutive weeks starting on \texttt{2022-02-16}
   		\item Each week's measurements are based on data from 14 crawls (2x/day)
   		\item Diversity in \texttt{k-buckets} is measured as the number of distinct \texttt{peer\_id}s observed in each bucket for all peers
   \end{itemize}
\end{column}
\begin{column}{0.58\textwidth}
    \begin{center}
		\includegraphics[width=\textwidth]{plots/online-peers-per-week.png}
    \end{center}
\end{column}
\end{columns}
\end{frame}

\begin{frame}
\frametitle{Diversity in each k-buckets}

\begin{columns}[onlytextwidth]
\begin{column}{0.38\textwidth}
   \begin{itemize}
   		\item Buckets \texttt{10+}: non-full buckets $\rightarrow$ low diversity
   		\item Bucket \texttt{9}: bucket just full \\$\rightarrow$ highest diversity
   		\item Buckets \texttt{0-1}: many candidates, only the most stable don't get evicted \\$\rightarrow$ lower diversity
   		\item We expect diversity in buckets \texttt{0-1} to decrease over time
   \end{itemize}
\end{column}
\begin{column}{0.58\textwidth}
    \begin{center}
		\includegraphics[width=\textwidth]{plots/diversity-in-buckets.png}
    \end{center}
\end{column}
\end{columns}
\end{frame}

\begin{frame}
\frametitle{Diversity evolution over time}

\begin{columns}[onlytextwidth]
\begin{column}{0.38\textwidth}
   Moving average difference between week 1 and week 8:
   \begin{itemize}
   		\item[] Bucket 0: \hspace{1em}\textbf{-6.9\%}
   		\item[] Bucket 1: \hspace{1em}\textbf{-7.3\%}
   		\item[] Bucket 9: \hspace{1em}-2.6\%
   \end{itemize}
\end{column}
\begin{column}{0.58\textwidth}
    \begin{center}
		\includegraphics[width=\textwidth]{plots/diversity-b0-b1-b9.png}
    \end{center}
\end{column}
\end{columns}
\end{frame}

\begin{frame}
\frametitle{Conclusion}
\begin{itemize}
	\item Very low rate of stale entries in the routing table, given high churn
	\item Peers distributions in the \texttt{k-buckets} as expected
	\item the \texttt{k-buckets} are only missing a small number of peers
	\item \texttt{95.2\%} of the nodes have at least 18 of their 20 closest peers in their Routing Table
	\item We observed diversity decreasing over time in low ID buckets, which might become a concern for decentralization
	\bigskip
	\item All results of \hyperlink{https://github.com/protocol/network-measurements/blob/rfm19/results/rfm19-dht-routing-table-health.md}{\texttt{RFM19}} of are available on the \hyperlink{https://github.com/protocol/network-measurements}{\texttt{protocol/network-measurements}} Github repo
\end{itemize}
\end{frame}

\begin{frame}
\frametitle{References}
\begin{enumerate}
	\item \hyperlink{https://github.com/protocol/network-measurements/blob/rfm19/results/rfm19-dht-routing-table-health.md}{\texttt{RFM19}} on the \hyperlink{https://github.com/protocol/network-measurements}{\texttt{protocol/network-measurements}} Github repo
	\item DHT Routing Table Health \hyperlink{https://www.notion.so/pl-strflt/DHT-Routing-Table-Health-f8e6836c4b09440baa909a4448a88fbf}{Notion page}
	\item \hyperlink{https://ipfs.io/ipfs/QmaVrnwZrnoG4YramcN75mbE5AUfCymiEErrHGXoQR968V}{Kademlia Paper} by Petar Maymounkov and David MaziÃ¨res
	\item \hyperlink{https://github.com/dennis-tra/nebula-crawler}{Nebula Crawler} by Dennis Trautwein
	\item \hyperlink{https://github.com/guillaumemichel/py-binary-trie}{Python Binary Trie implementation}
	\item \hyperlink{https://www.notion.so/pl-strflt/ProbeLab-Protocol-Benchmarking-Optimization-a63238fd1b184d6f8fea4bb38d975208}{ProbeLab Notion page}
\end{enumerate}
\end{frame}



\end{document}